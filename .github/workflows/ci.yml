name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  ELIXIR_VERSION: "1.19.4"
  OTP_VERSION: "28.0"
  MIX_ENV: test

jobs:
  # Job 1: Code Quality & Formatting
  quality:
    name: Code Quality & Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Check code formatting
        run: mix format --check-formatted
        continue-on-error: true

      - name: Compile project (warnings as errors)
        run: mix compile --warnings-as-errors

  # Job 2: Automated Tests
  test:
    name: Automated Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: hookhub
          POSTGRES_PASSWORD: hookhub_dev
          POSTGRES_DB: hookhub_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile project
        run: mix compile

      - name: Run database migrations
        run: mix ecto.create && mix ecto.migrate
        env:
          DB_USER: hookhub
          DB_PASSWORD: hookhub_dev
          DB_HOST: localhost
          DB_NAME: hookhub_test

      - name: Run tests
        run: mix test
        env:
          DB_USER: hookhub
          DB_PASSWORD: hookhub_dev
          DB_HOST: localhost
          DB_NAME: hookhub_test

  # Job 3: Docker Build & Validate
  docker:
    name: Docker Build & Validate
    runs-on: ubuntu-latest
    needs: [quality, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: hookhub:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker Compose setup
        run: |
          docker compose up -d
          sleep 15
          docker compose ps
          docker compose logs app
          # Test healthcheck
          curl -f http://localhost:4000 || exit 1
          docker compose down -v

  # Job 4: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Check for security vulnerabilities
        run: mix deps.audit
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true

  # Job 5: Deploy to Production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality, test, docker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "ðŸš€ Ready to deploy to production!"
          echo "Add your deployment steps here (e.g., Fly.io, Gigalixir, AWS, etc.)"

      # Example: Deploy to Fly.io
      # - name: Deploy to Fly.io
      #   uses: superfly/flyctl-actions/setup-flyctl@master
      # - run: flyctl deploy --remote-only
      #   env:
      #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      #
      # Example: Deploy to Gigalixir
      # - name: Deploy to Gigalixir
      #   uses: mhanberg/gigalixir-action@v0.7.1
      #   with:
      #     GIGALIXIR_USERNAME: ${{ secrets.GIGALIXIR_USERNAME }}
      #     GIGALIXIR_PASSWORD: ${{ secrets.GIGALIXIR_PASSWORD }}
      #     GIGALIXIR_APP: your-app-name
      #     SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #     MIGRATIONS: false
